<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>管理员面板 - 优图充值系统</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * { box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
            color: #333;
        }
        
        .navbar {
            background: rgba(255,255,255,0.9);
            padding: 12px 20px;
            box-shadow: 0 1px 8px rgba(0,0,0,0.08);
            display: flex;
            justify-content: space-between;
            align-items: center;
            backdrop-filter: blur(10px);
        }
        
        .navbar-brand {
            font-size: 18px;
            font-weight: bold;
            color: #667eea;
        }
        
        .navbar-nav {
            display: flex;
            gap: 20px;
            align-items: center;
        }
        
        .navbar-nav a {
            text-decoration: none;
            color: #333;
            font-weight: 500;
            padding: 8px 15px;
            border-radius: 6px;
            transition: all 0.3s ease;
        }
        
        .navbar-nav a:hover {
            background-color: #667eea;
            color: white;
        }
        
        .container {
            max-width: 1200px;
            margin: 30px auto;
            padding: 0 20px;
        }
        
        .tabs {
            display: flex;
            background: white;
            border-radius: 10px 10px 0 0;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .tab-button {
            flex: 1;
            padding: 15px 20px;
            background: #f8f9fa;
            border: none;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            color: #666;
            transition: all 0.3s ease;
        }
        
        .tab-button.active {
            background: #667eea;
            color: white;
        }
        
        .tab-button:hover {
            background: #e9ecef;
        }
        
        .tab-button.active:hover {
            background: #667eea;
        }
        
        .tab-content {
            background: white;
            border-radius: 0 0 10px 10px;
            padding: 25px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .tab-pane {
            display: none;
        }
        
        .tab-pane.active {
            display: block;
        }
        
        .table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        .table th,
        .table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        
        .table th {
            background-color: #f8f9fa;
            font-weight: 600;
            color: #555;
        }
        
        .table tbody tr:hover {
            background-color: #f8f9ff;
        }
        
        .role-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .role-admin {
            background-color: #e8f5e8;
            color: #388e3c;
        }
        
        .role-user {
            background-color: #e3f2fd;
            color: #1976d2;
        }
        
        .status-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .status-active {
            background-color: #e8f5e8;
            color: #388e3c;
        }
        
        .status-inactive {
            background-color: #ffebee;
            color: #d32f2f;
        }
        
        .btn {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            text-decoration: none;
            display: inline-block;
            transition: all 0.3s ease;
            margin: 2px;
        }
        
        .btn-primary {
            background-color: #667eea;
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #5a6fd6;
        }
        
        .btn-success {
            background-color: #28a745;
            color: white;
        }
        
        .btn-warning {
            background-color: #ffc107;
            color: #333;
        }
        
        .btn-danger {
            background-color: #dc3545;
            color: white;
        }
        
        .btn-secondary {
            background-color: #6c757d;
            color: white;
        }
        
        .btn-sm {
            padding: 4px 8px;
            font-size: 11px;
        }
        
        .text-muted {
            color: #6c757d;
        }
        
        .empty-state {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        .empty-state i {
            font-size: 48px;
            margin-bottom: 20px;
            color: #ccc;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }
        
        .stat-card h3 {
            margin: 0 0 10px 0;
            font-size: 24px;
            font-weight: 600;
        }
        
        .stat-card p {
            margin: 0;
            font-size: 14px;
            opacity: 0.9;
        }
        
        .loading {
            text-align: center;
            color: #666;
            font-style: italic;
        }
        
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .section-header h3 {
            margin: 0;
            color: #333;
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="navbar-brand">
            <i class="fas fa-chart-line"></i> 优图充值系统
        </div>
        <div class="navbar-nav">
            <a href="{{ url_for('index') }}"><i class="fas fa-home"></i> 首页</a>
            <a href="{{ url_for('orders') }}"><i class="fas fa-list"></i> 订单管理</a>
            <a href="{{ url_for('sellers') }}"><i class="fas fa-users"></i> 卖家管理</a>
            <a href="{{ url_for('admin') }}"><i class="fas fa-cog"></i> 管理面板</a>
            <a href="{{ url_for('profile') }}"><i class="fas fa-user"></i> 个人资料</a>
            <a href="{{ url_for('logout') }}"><i class="fas fa-sign-out-alt"></i> 退出</a>
        </div>
    </nav>
    
    <div class="container">
        <!-- 统计卡片 -->
        <div class="stats-grid">
            <div class="stat-card">
                <h3 id="total-users">{{ users|length if users else 0 }}</h3>
                <p>总用户数</p>
            </div>
            <div class="stat-card">
                <h3 id="total-sellers">0</h3>
                <p>总卖家数</p>
            </div>
            <div class="stat-card">
                <h3 id="active-sellers">0</h3>
                <p>活跃卖家</p>
            </div>
            <div class="stat-card">
                <h3 id="today-orders">0</h3>
                <p>今日订单</p>
            </div>
        </div>
        
        <!-- 标签页导航 -->
        <div class="tabs">
            <button class="tab-button active" onclick="showTab('users')">
                <i class="fas fa-users"></i> 用户管理
            </button>
            <button class="tab-button" onclick="showTab('sellers')">
                <i class="fas fa-store"></i> 卖家管理
            </button>
        </div>
        
        <!-- 标签页内容 -->
        <div class="tab-content">
            <!-- 用户管理标签页 -->
            <div id="users-tab" class="tab-pane active">
                <div class="section-header">
                    <h3><i class="fas fa-users"></i> 用户管理</h3>
                </div>
                
                <div class="table-responsive">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>用户名</th>
                                <th>邮箱</th>
                                <th>角色</th>
                                <th>注册时间</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="users-table-body">
                            {% if users %}
                                {% for user in users %}
                                <tr>
                                    <td>{{ user.id }}</td>
                                    <td>{{ user.username }}</td>
                                    <td>{{ user.email or '-' }}</td>
                                    <td>
                                        <span class="role-badge {{ 'role-admin' if user.role == 'admin' else 'role-user' }}">
                                            {{ '管理员' if user.role == 'admin' else '用户' }}
                                        </span>
                                    </td>
                                    <td class="text-muted">
                                        {% if user.created_at %}
                                            {{ user.created_at.strftime('%Y-%m-%d') }}
                                        {% else %}
                                            -
                                        {% endif %}
                                    </td>
                                    <td>
                                        <select onchange="updateUserRole('{{ user.id }}', this.value)" class="btn btn-sm btn-secondary">
                                            <option value="user" {{ 'selected' if user.role == 'user' else '' }}>用户</option>
                                            <option value="admin" {{ 'selected' if user.role == 'admin' else '' }}>管理员</option>
                                        </select>
                                        <button onclick="deleteUser('{{ user.id }}')" class="btn btn-sm btn-danger">
                                            <i class="fas fa-trash"></i> 删除
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            {% else %}
                                <tr>
                                    <td colspan="6" class="loading">暂无用户数据</td>
                                </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- 卖家管理标签页 -->
            <div id="sellers-tab" class="tab-pane">
                <div class="section-header">
                    <h3><i class="fas fa-store"></i> 卖家管理</h3>
                    <button onclick="showAddSellerModal()" class="btn btn-primary">
                        <i class="fas fa-plus"></i> 添加卖家
                    </button>
                </div>
                
                <div class="table-responsive">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Telegram ID</th>
                                <th>昵称</th>
                                <th>用户名</th>
                                <th>真实姓名</th>
                                <th>状态</th>
                                <th>添加时间</th>
                                <th>最后活跃</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="sellers-table-body">
                            <tr>
                                <td colspan="8" class="loading">加载中...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 添加卖家模态框 -->
    <div id="add-seller-modal" class="modal" style="display:none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>添加新卖家</h3>
                <span class="close-modal">&times;</span>
            </div>
            <div class="modal-body">
                <div id="add-seller-error" class="error-message" style="display:none;"></div>
                <form id="add-seller-form">
                    <div class="form-group">
                        <label for="new-seller-id">Telegram ID *</label>
                        <input type="number" id="new-seller-id" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="new-seller-username">用户名</label>
                        <input type="text" id="new-seller-username" class="form-control">
                    </div>
                    <div class="form-group">
                        <label for="new-seller-firstname">真实姓名</label>
                        <input type="text" id="new-seller-firstname" class="form-control">
                    </div>
                    <div class="form-group">
                        <label for="new-seller-nickname">显示昵称</label>
                        <input type="text" id="new-seller-nickname" class="form-control">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('add-seller-modal')">取消</button>
                <button class="btn btn-primary" onclick="addSeller()">添加</button>
            </div>
        </div>
    </div>
    
    <!-- 模态框和表单样式 -->
    <style>
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        
        .modal-content {
            background-color: #fefefe;
            margin: 15% auto;
            padding: 0;
            border-radius: 10px;
            width: 80%;
            max-width: 500px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .modal-header {
            padding: 20px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-header h3 {
            margin: 0;
            color: #333;
        }
        
        .modal-body {
            padding: 20px;
        }
        
        .modal-footer {
            padding: 20px;
            border-top: 1px solid #eee;
            text-align: right;
        }
        
        .close-modal {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .close-modal:hover {
            color: #000;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #555;
        }
        
        .form-control {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .error-message {
            background-color: #f8d7da;
            color: #721c24;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 15px;
            font-size: 14px;
        }
        
        .table-responsive {
            overflow-x: auto;
        }
    </style>
    
    <script>
                 // 标签页切换
         function showTab(tabName) {
             // 隐藏所有标签页内容
             const tabPanes = document.querySelectorAll('.tab-pane');
             tabPanes.forEach(pane => pane.classList.remove('active'));
             
             // 移除所有按钮的活动状态
             const tabButtons = document.querySelectorAll('.tab-button');
             tabButtons.forEach(button => button.classList.remove('active'));
             
             // 显示选中的标签页
             document.getElementById(tabName + '-tab').classList.add('active');
             
             // 激活对应的按钮
             document.querySelectorAll('.tab-button').forEach((button, index) => {
                 if ((tabName === 'users' && index === 0) || (tabName === 'sellers' && index === 1)) {
                     button.classList.add('active');
                 }
             });
             
             // 如果是卖家标签页，加载卖家数据
             if (tabName === 'sellers') {
                 loadSellers();
             }
         }
        
        // 加载卖家数据
        async function loadSellers() {
            try {
                const tbody = document.getElementById('sellers-table-body');
                if (!tbody) return;
                
                tbody.innerHTML = '<tr><td colspan="8" class="loading">加载中...</td></tr>';
                
                const response = await fetch('/admin/api/sellers');
                if (!response.ok) {
                    tbody.innerHTML = '<tr><td colspan="8" class="loading">加载失败，请刷新重试</td></tr>';
                    return;
                }
                
                const sellers = await response.json();
                
                tbody.innerHTML = '';
                
                if (sellers.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="8" style="text-align:center; padding: 40px;">暂无卖家</td></tr>';
                    return;
                }
                
                sellers.forEach(seller => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${seller.telegram_id}</td>
                        <td>${seller.nickname || '-'}</td>
                        <td>${seller.username || '-'}</td>
                        <td>${seller.first_name || '-'}</td>
                        <td>
                            <span class="status-badge ${seller.is_active ? 'status-active' : 'status-inactive'}">
                                ${seller.is_active ? '激活' : '禁用'}
                            </span>
                        </td>
                        <td class="text-muted">${seller.added_at ? new Date(seller.added_at).toLocaleDateString() : '-'}</td>
                        <td class="text-muted">${seller.last_active_at ? new Date(seller.last_active_at).toLocaleString() : '从未活跃'}</td>
                        <td>
                            <button onclick="editSeller('${seller.telegram_id}', '${seller.nickname || ''}')" class="btn btn-sm btn-secondary">
                                <i class="fas fa-edit"></i> 编辑
                            </button>
                            <button onclick="toggleSeller('${seller.telegram_id}')" class="btn btn-sm ${seller.is_active ? 'btn-warning' : 'btn-success'}">
                                <i class="fas fa-${seller.is_active ? 'pause' : 'play'}"></i> ${seller.is_active ? '禁用' : '启用'}
                            </button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
                
                // 更新统计
                document.getElementById('total-sellers').textContent = sellers.length;
                document.getElementById('active-sellers').textContent = sellers.filter(s => s.is_active).length;
                
            } catch (error) {
                console.error('加载卖家数据失败:', error);
                document.getElementById('sellers-table-body').innerHTML = '<tr><td colspan="8" class="loading">网络错误，请刷新重试</td></tr>';
            }
        }
        
        // 更新用户角色
        async function updateUserRole(userId, newRole) {
            try {
                const response = await fetch(`/api/users/${userId}/role`, {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({role: newRole})
                });
                
                if (response.ok) {
                    alert('用户角色更新成功');
                } else {
                    const result = await response.json();
                    alert(result.message || '更新失败');
                }
            } catch (error) {
                alert('网络错误');
            }
        }
        
        // 删除用户
        async function deleteUser(userId) {
            if (!confirm(`确定要删除ID为 ${userId} 的用户吗？此操作不可恢复！`)) {
                return;
            }
            
            try {
                const response = await fetch(`/admin/api/users/${userId}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    alert('用户已成功删除');
                    window.location.reload();
                } else {
                    const result = await response.json();
                    alert(result.error || '删除用户失败');
                }
            } catch (error) {
                alert('网络错误，删除失败');
            }
        }
        
        // 显示添加卖家模态框
        function showAddSellerModal() {
            document.getElementById('add-seller-modal').style.display = 'block';
        }
        
        // 关闭模态框
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }
        
        // 添加卖家
        async function addSeller() {
            const errorDiv = document.getElementById('add-seller-error');
            const telegramId = document.getElementById('new-seller-id').value;
            
            if (!telegramId) {
                errorDiv.textContent = 'Telegram ID 不能为空。';
                errorDiv.style.display = 'block';
                return;
            }
            
            const data = {
                telegram_id: parseInt(telegramId),
                username: document.getElementById('new-seller-username').value,
                first_name: document.getElementById('new-seller-firstname').value,
                nickname: document.getElementById('new-seller-nickname').value
            };
            
            try {
                const response = await fetch('/admin/api/sellers', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });
                
                if (response.ok) {
                    // 清空输入
                    document.getElementById('new-seller-id').value = '';
                    document.getElementById('new-seller-username').value = '';
                    document.getElementById('new-seller-firstname').value = '';
                    document.getElementById('new-seller-nickname').value = '';
                    errorDiv.style.display = 'none';
                    
                    alert('卖家添加成功！');
                    closeModal('add-seller-modal');
                    loadSellers(); // 重新加载卖家列表
                } else {
                    const result = await response.json();
                    errorDiv.textContent = result.error || '添加失败，请重试。';
                    errorDiv.style.display = 'block';
                }
            } catch (error) {
                errorDiv.textContent = '网络错误，请重试。';
                errorDiv.style.display = 'block';
            }
        }
        
        // 编辑卖家
        async function editSeller(telegramId, currentNickname) {
            const newNickname = prompt('请输入新的显示昵称', currentNickname || '');
            if (newNickname === null) return;
            
            try {
                const response = await fetch(`/admin/api/sellers/${telegramId}`, {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({nickname: newNickname})
                });
                
                if (response.ok) {
                    alert('卖家昵称已更新');
                    loadSellers();
                } else {
                    alert('更新失败');
                }
            } catch (error) {
                alert('网络错误');
            }
        }
        
        // 切换卖家状态
        async function toggleSeller(telegramId) {
            try {
                const response = await fetch(`/admin/api/sellers/${telegramId}/toggle`, {
                    method: 'POST'
                });
                
                if (response.ok) {
                    loadSellers();
                } else {
                    alert('操作失败');
                }
            } catch (error) {
                alert('网络错误');
            }
        }
        
        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 加载今日订单统计
            fetch('/api/today-stats')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        document.getElementById('today-orders').textContent = data.total_orders || 0;
                    }
                })
                .catch(error => console.error('加载统计失败:', error));
            
            // 设置模态框关闭事件
            window.onclick = function(event) {
                const modal = document.getElementById('add-seller-modal');
                if (event.target === modal) {
                    closeModal('add-seller-modal');
                }
            }
            
            // 关闭按钮事件
            const closeButtons = document.querySelectorAll('.close-modal');
            closeButtons.forEach(button => {
                button.onclick = function() {
                    const modal = this.closest('.modal');
                    if (modal) {
                        modal.style.display = 'none';
                    }
                }
            });
        });
    </script>
</body>
</html> 