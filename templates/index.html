<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>ç ´å¤©å……å€¼ç³»ç»Ÿ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    * { box-sizing: border-box; }
    body { 
      font-family: 'Microsoft YaHei', Arial, sans-serif; 
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      margin: 0; padding: 0; min-height: 100vh;
      color: #333;
    }
    
    .navbar {
      background: rgba(255,255,255,0.95);
      padding: 15px 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .navbar-brand {
      font-size: 24px;
      font-weight: bold;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    .navbar-user {
      display: flex;
      align-items: center;
      gap: 20px;
    }
    .user-info {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .user-role {
      font-size: 12px;
      padding: 2px 8px;
      border-radius: 12px;
      color: white;
    }
    .role-admin {
      background-color: #dc3545;
    }
    .role-user {
      background-color: #28a745;
    }
    .btn {
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.3s ease;
      text-decoration: none;
      display: inline-block;
    }
    .btn:hover {
      transform: translateY(-1px);
    }
    .btn-primary { background: #667eea; color: white; }
    .btn-danger { background: #dc3545; color: white; }
    .btn-info { background: #17a2b8; color: white; }
    
    .main-container {
      max-width: 800px;
      margin: 20px auto;
      padding: 20px;
    }
    
    .upload-section {
      background: rgba(255,255,255,0.95);
      border-radius: 15px;
      padding: 30px;
      margin-bottom: 20px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.1);
      backdrop-filter: blur(10px);
    }
    
    .upload-section h2 {
      margin-top: 0;
      color: #333;
      text-align: center;
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #555;
    }
    
    .form-group input, .form-group select, .form-group textarea {
      width: 100%;
      padding: 12px;
      border: 2px solid #e1e5e9;
      border-radius: 8px;
      font-size: 14px;
      transition: all 0.3s ease;
    }
    
    .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102,126,234,0.1);
    }
    
    .upload-area {
      border: 2px dashed #e1e5e9;
      border-radius: 12px;
      padding: 20px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
      background: rgba(255,255,255,0.5);
      position: relative;
      min-height: 120px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .upload-area:hover {
      border-color: #667eea;
      background: rgba(102,126,234,0.05);
    }
    
    .upload-area.drag-over {
      border-color: #667eea;
      background: rgba(102,126,234,0.1);
      transform: scale(1.02);
    }
    
    .upload-placeholder {
      width: 100%;
    }
    
    .upload-icon {
      font-size: 40px;
      margin-bottom: 10px;
    }
    
    .upload-text {
      font-size: 16px;
      color: #333;
      margin-bottom: 5px;
      font-weight: 500;
    }
    
    .upload-hint {
      font-size: 12px;
      color: #666;
    }
    
    .upload-preview {
      width: 100%;
      position: relative;
      border-radius: 8px;
      overflow: hidden;
    }
    
    .upload-preview img {
      width: 100%;
      max-height: 200px;
      object-fit: contain;
      border-radius: 8px;
    }
    
    .upload-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    
    .upload-preview:hover .upload-overlay {
      opacity: 1;
    }
    
    .change-btn {
      background: #667eea;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.3s ease;
    }
    
    .change-btn:hover {
      background: #764ba2;
      transform: translateY(-1px);
    }
    
    .submit-btn {
      width: 100%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 15px;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .submit-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102,126,234,0.3);
    }
    
    .orders-section {
      background: rgba(255,255,255,0.95);
      border-radius: 15px;
      padding: 30px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.1);
      backdrop-filter: blur(10px);
    }
    
    .orders-section h2 {
      margin-top: 0;
      color: #333;
      text-align: center;
    }
    
    .order-item {
      border: 1px solid #e1e5e9;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 10px;
      background: #f8f9fa;
    }
    
    .order-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
    
    .order-id {
      font-weight: bold;
      color: #667eea;
    }
    
    .order-status {
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: 600;
    }
    
    .status-submitted { background: #fff3cd; color: #856404; }
    .status-accepted { background: #d1ecf1; color: #0c5460; }
    .status-completed { background: #d4edda; color: #155724; }
    .status-failed { background: #f8d7da; color: #721c24; }
    
    .order-details {
      font-size: 14px;
      color: #666;
    }
    
    .alert {
      padding: 12px 16px;
      border-radius: 8px;
      margin-bottom: 20px;
      font-size: 14px;
    }
    
    .alert-success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    
    .alert-error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    
    .loading {
      text-align: center;
      color: #666;
      font-style: italic;
    }
  </style>
</head>
<body>
  <div class="navbar">
    <div class="navbar-brand">ç ´å¤©å……å€¼ç³»ç»Ÿ</div>
    <div class="navbar-user">
      {% if user %}
        <div class="user-info">
          <span>æ¬¢è¿ï¼Œ{{ user.username }}</span>
          <span class="user-role role-{{ user.role }}">{{ 'ç®¡ç†å‘˜' if user.role == 'admin' else 'ç”¨æˆ·' }}</span>
        </div>
        <a href="{{ url_for('profile') }}" class="btn btn-info">ä¸ªäººèµ„æ–™</a>
        {% if user.role == 'admin' %}
          <a href="{{ url_for('admin') }}" class="btn btn-info">ç®¡ç†åå°</a>
          <a href="{{ url_for('sellers') }}" class="btn btn-info">å–å®¶ç®¡ç†</a>
        {% endif %}
        <a href="{{ url_for('orders') }}" class="btn btn-info">è®¢å•ç®¡ç†</a>
        <a href="{{ url_for('logout') }}" class="btn btn-danger">é€€å‡º</a>
      {% else %}
        <a href="{{ url_for('login') }}" class="btn btn-primary">ç™»å½•</a>
        <a href="{{ url_for('register') }}" class="btn btn-info">æ³¨å†Œ</a>
      {% endif %}
    </div>
  </div>

  <div class="main-container">
    {% if not user %}
      <!-- æœªç™»å½•ç”¨æˆ·æ˜¾ç¤º -->
      <div class="upload-section">
        <h2>æ¬¢è¿ä½¿ç”¨ç ´å¤©å……å€¼ç³»ç»Ÿ</h2>
        <p style="text-align: center; color: #666; margin: 20px 0;">
          è¯·å…ˆç™»å½•æˆ–æ³¨å†Œè´¦æˆ·ä»¥ä½¿ç”¨å……å€¼æœåŠ¡
        </p>
        <div style="text-align: center;">
          <a href="{{ url_for('login') }}" class="btn btn-primary" style="margin-right: 10px;">ç«‹å³ç™»å½•</a>
          <a href="{{ url_for('register') }}" class="btn btn-info">æ³¨å†Œè´¦æˆ·</a>
        </div>
      </div>
    {% else %}
      <!-- å·²ç™»å½•ç”¨æˆ·æ˜¾ç¤ºä¸Šä¼ åŠŸèƒ½ -->
      <div class="upload-section">
      <h2>ä¸Šä¼ ä»˜æ¬¾ç </h2>
      <form id="uploadForm" enctype="multipart/form-data">
        <div class="form-group">
          <label for="qr_code">ä»˜æ¬¾ç å›¾ç‰‡ * <span style="font-size: 12px; color: #666;">(ç‚¹å‡»ä¸Šä¼ æ¡†æˆ–Ctrl+Vç²˜è´´)</span></label>
          <div class="upload-area" id="uploadArea">
            <input type="file" id="qr_code" name="qr_code" accept="image/*" required style="display: none;">
            <div class="upload-placeholder" id="uploadPlaceholder">
              <div class="upload-icon">ğŸ“·</div>
              <div class="upload-text">ç‚¹å‡»æ­¤å¤„ä¸Šä¼ å›¾ç‰‡æˆ–ç²˜è´´å‰ªåˆ‡æ¿å›¾ç‰‡</div>
              <div class="upload-hint">æ”¯æŒ JPGã€PNGã€GIF æ ¼å¼</div>
            </div>
            <div class="upload-preview" id="uploadPreview" style="display: none;">
              <img id="previewImage" src="" alt="é¢„è§ˆå›¾ç‰‡">
              <div class="upload-overlay">
                <button type="button" class="change-btn" onclick="changeImage()">æ›´æ¢å›¾ç‰‡</button>
              </div>
            </div>
          </div>
        </div>
        
        <div class="form-group">
          <label for="package">å¥—é¤é€‰æ‹©</label>
          <select id="package" name="package">
            <option value="12">12ä¸ªæœˆ</option>
            <option value="6">6ä¸ªæœˆ</option>
            <option value="3">3ä¸ªæœˆ</option>
            <option value="1">1ä¸ªæœˆ</option>
          </select>
        </div>
        
        <div class="form-group">
          <label for="remark">å¤‡æ³¨ä¿¡æ¯</label>
          <textarea id="remark" name="remark" rows="3" placeholder="å¯é€‰ï¼šæ·»åŠ å¤‡æ³¨ä¿¡æ¯"></textarea>
        </div>
        
        <button type="submit" class="submit-btn">æäº¤è®¢å•</button>
      </form>
    </div>

      <!-- æœ€è¿‘è®¢å•åŒºåŸŸ -->
      <div class="orders-section">
        <h2>æœ€è¿‘è®¢å•</h2>
        <div id="ordersList">
          <div class="loading">åŠ è½½ä¸­...</div>
        </div>
      </div>
    {% endif %}
  </div>

  <script>
    // å›¾ç‰‡ä¸Šä¼ ç›¸å…³åŠŸèƒ½
    const uploadArea = document.getElementById('uploadArea');
    const fileInput = document.getElementById('qr_code');
    const uploadPlaceholder = document.getElementById('uploadPlaceholder');
    const uploadPreview = document.getElementById('uploadPreview');
    const previewImage = document.getElementById('previewImage');
    
    // ç‚¹å‡»ä¸Šä¼ åŒºåŸŸè§¦å‘æ–‡ä»¶é€‰æ‹©
    uploadArea.addEventListener('click', function() {
      fileInput.click();
    });
    
    // æ–‡ä»¶é€‰æ‹©å˜åŒ–
    fileInput.addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (file) {
        handleFileUpload(file);
      }
    });
    
    // æ‹–æ‹½ä¸Šä¼ 
    uploadArea.addEventListener('dragover', function(e) {
      e.preventDefault();
      uploadArea.classList.add('drag-over');
    });
    
    uploadArea.addEventListener('dragleave', function(e) {
      e.preventDefault();
      uploadArea.classList.remove('drag-over');
    });
    
    uploadArea.addEventListener('drop', function(e) {
      e.preventDefault();
      uploadArea.classList.remove('drag-over');
      
      const files = e.dataTransfer.files;
      if (files.length > 0) {
        const file = files[0];
        if (file.type.startsWith('image/')) {
          handleFileUpload(file);
          fileInput.files = files; // æ›´æ–°inputçš„files
        } else {
          showAlert('è¯·é€‰æ‹©å›¾ç‰‡æ–‡ä»¶ï¼', 'error');
        }
      }
    });
    
    // å‰ªåˆ‡æ¿ç²˜è´´åŠŸèƒ½
    document.addEventListener('paste', function(e) {
      const items = e.clipboardData.items;
      for (let i = 0; i < items.length; i++) {
        if (items[i].type.indexOf('image') !== -1) {
          const file = items[i].getAsFile();
          handleFileUpload(file);
          
          // åˆ›å»ºä¸€ä¸ªæ–°çš„FileListæ¥æ›´æ–°input
          const dt = new DataTransfer();
          dt.items.add(file);
          fileInput.files = dt.files;
          break;
        }
      }
    });
    
    // å¤„ç†æ–‡ä»¶ä¸Šä¼ é¢„è§ˆ
    function handleFileUpload(file) {
      if (!file.type.startsWith('image/')) {
        showAlert('è¯·é€‰æ‹©å›¾ç‰‡æ–‡ä»¶ï¼', 'error');
        return;
      }
      
      // æ£€æŸ¥æ–‡ä»¶å¤§å° (5MB)
      if (file.size > 5 * 1024 * 1024) {
        showAlert('å›¾ç‰‡æ–‡ä»¶ä¸èƒ½è¶…è¿‡5MBï¼', 'error');
        return;
      }
      
      const reader = new FileReader();
      reader.onload = function(e) {
        previewImage.src = e.target.result;
        uploadPlaceholder.style.display = 'none';
        uploadPreview.style.display = 'block';
      };
      reader.readAsDataURL(file);
    }
    
    // æ›´æ¢å›¾ç‰‡
    function changeImage() {
      fileInput.click();
    }
    
    // é‡ç½®ä¸Šä¼ çŠ¶æ€
    function resetUpload() {
      uploadPlaceholder.style.display = 'block';
      uploadPreview.style.display = 'none';
      fileInput.value = '';
    }
    
    // æäº¤è®¢å•
    document.getElementById('uploadForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const formData = new FormData(this);
      const submitBtn = this.querySelector('.submit-btn');
      const originalText = submitBtn.textContent;
      
      submitBtn.textContent = 'æäº¤ä¸­...';
      submitBtn.disabled = true;
      
      try {
        const response = await fetch('/', {
          method: 'POST',
          body: formData
        });
        
        const result = await response.json();
        
        if (result.success) {
          showAlert('è®¢å•æäº¤æˆåŠŸï¼', 'success');
          this.reset();
          resetUpload(); // é‡ç½®ä¸Šä¼ çŠ¶æ€
          loadOrders();
        } else {
          showAlert(result.error || 'æäº¤å¤±è´¥', 'error');
        }
      } catch (error) {
        showAlert('ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•', 'error');
      } finally {
        submitBtn.textContent = originalText;
        submitBtn.disabled = false;
      }
    });

    // æ˜¾ç¤ºæç¤ºä¿¡æ¯
    function showAlert(message, type) {
      const alert = document.createElement('div');
      alert.className = `alert alert-${type}`;
      alert.textContent = message;
      
      const container = document.querySelector('.main-container');
      container.insertBefore(alert, container.firstChild);
      
      setTimeout(() => {
        alert.remove();
      }, 3000);
    }

    // åŠ è½½è®¢å•åˆ—è¡¨
    async function loadOrders() {
      const ordersList = document.getElementById('ordersList');
      if (!ordersList) return; // å¦‚æœæ²¡æœ‰è®¢å•åˆ—è¡¨å…ƒç´ åˆ™è¿”å›
      
      try {
        const response = await fetch('/orders/recent');
        const result = await response.json();
        
        if (result.success && result.orders) {
          if (result.orders.length === 0) {
            ordersList.innerHTML = '<div class="loading">æš‚æ— è®¢å•</div>';
            return;
          }
          
          ordersList.innerHTML = result.orders.map(order => `
            <div class="order-item">
              <div class="order-header">
                <span class="order-id">è®¢å• #${order[0]}</span>
                <span class="order-status status-${order[3]}">${getStatusText(order[3])}</span>
              </div>
              <div class="order-details">
                <div>å¥—é¤: ${order[2]}ä¸ªæœˆ</div>
                <div>åˆ›å»ºæ—¶é—´: ${order[4]}</div>
              </div>
            </div>
          `).join('');
        } else {
          ordersList.innerHTML = '<div class="loading">åŠ è½½å¤±è´¥</div>';
        }
      } catch (error) {
        ordersList.innerHTML = '<div class="loading">åŠ è½½å¤±è´¥</div>';
      }
    }

    // è·å–çŠ¶æ€æ–‡æœ¬
    function getStatusText(status) {
      const statusMap = {
        'submitted': 'å·²æäº¤',
        'accepted': 'å·²æ¥å•',
        'completed': 'å·²å®Œæˆ',
        'failed': 'å¤±è´¥',
        'cancelled': 'å·²å–æ¶ˆ',
        'disputing': 'äº‰è®®ä¸­'
      };
      return statusMap[status] || status;
    }

    // é¡µé¢åŠ è½½æ—¶è·å–è®¢å•
    window.addEventListener('load', function() {
      // æ£€æŸ¥æ˜¯å¦æœ‰è®¢å•åˆ—è¡¨å…ƒç´ ï¼ˆåªæœ‰ç™»å½•ç”¨æˆ·æ‰æœ‰ï¼‰
      if (document.getElementById('ordersList')) {
        loadOrders();
      }
    });
  </script>
</body>
</html> 