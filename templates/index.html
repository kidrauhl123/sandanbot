<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>破天充值系统</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    * { box-sizing: border-box; }
    body { 
      font-family: 'Microsoft YaHei', Arial, sans-serif; 
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      margin: 0; padding: 0; min-height: 100vh;
      color: #333;
    }
    
    .navbar {
      background: rgba(255,255,255,0.95);
      padding: 15px 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .navbar-brand {
      font-size: 24px;
      font-weight: bold;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    .navbar-user {
      display: flex;
      align-items: center;
      gap: 20px;
    }
    .user-info {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .user-role {
      font-size: 12px;
      padding: 2px 8px;
      border-radius: 12px;
      color: white;
    }
    .role-admin {
      background-color: #dc3545;
    }
    .role-user {
      background-color: #28a745;
    }
    .btn {
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.3s ease;
      text-decoration: none;
      display: inline-block;
    }
    .btn:hover {
      transform: translateY(-1px);
    }
    .btn-primary { background: #667eea; color: white; }
    .btn-danger { background: #dc3545; color: white; }
    .btn-info { background: #17a2b8; color: white; }
    
    .main-container {
      max-width: 800px;
      margin: 20px auto;
      padding: 20px;
    }
    
    .upload-section {
      background: rgba(255,255,255,0.95);
      border-radius: 15px;
      padding: 30px;
      margin-bottom: 20px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.1);
      backdrop-filter: blur(10px);
    }
    
    .upload-section h2 {
      margin-top: 0;
      color: #333;
      text-align: center;
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #555;
    }
    
    .form-group input, .form-group select, .form-group textarea {
      width: 100%;
      padding: 12px;
      border: 2px solid #e1e5e9;
      border-radius: 8px;
      font-size: 14px;
      transition: all 0.3s ease;
    }
    
    .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102,126,234,0.1);
    }
    
    .upload-area {
      border: 2px dashed #e1e5e9;
      border-radius: 12px;
      padding: 20px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
      background: rgba(255,255,255,0.5);
      position: relative;
      min-height: 120px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .upload-area:hover {
      border-color: #667eea;
      background: rgba(102,126,234,0.05);
    }
    
    .upload-area.drag-over {
      border-color: #667eea;
      background: rgba(102,126,234,0.1);
      transform: scale(1.02);
    }
    
    .upload-placeholder {
      width: 100%;
    }
    
    .upload-icon {
      font-size: 40px;
      margin-bottom: 10px;
    }
    
    .upload-text {
      font-size: 16px;
      color: #333;
      margin-bottom: 5px;
      font-weight: 500;
    }
    
    .upload-hint {
      font-size: 12px;
      color: #666;
    }
    
    .upload-preview {
      width: 100%;
      position: relative;
      border-radius: 8px;
      overflow: hidden;
    }
    
    .upload-preview img {
      width: 100%;
      max-height: 200px;
      object-fit: contain;
      border-radius: 8px;
    }
    
    .upload-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    
    .upload-preview:hover .upload-overlay {
      opacity: 1;
    }
    
    .change-btn {
      background: #667eea;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.3s ease;
    }
    
    .change-btn:hover {
      background: #764ba2;
      transform: translateY(-1px);
    }
    
    .submit-btn {
      width: 100%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 15px;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .submit-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102,126,234,0.3);
    }
    
    .orders-section {
      background: rgba(255,255,255,0.95);
      border-radius: 15px;
      padding: 30px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.1);
      backdrop-filter: blur(10px);
    }
    
    .orders-section h2 {
      margin-top: 0;
      color: #333;
      text-align: center;
    }
    
    .order-item {
      border: 1px solid #e1e5e9;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 10px;
      background: #f8f9fa;
    }
    
    .order-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
    
    .order-id {
      font-weight: bold;
      color: #667eea;
    }
    
    .order-status {
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: 600;
    }
    
    .status-submitted { background: #fff3cd; color: #856404; }
    .status-accepted { background: #d1ecf1; color: #0c5460; }
    .status-completed { background: #d4edda; color: #155724; }
    .status-failed { background: #f8d7da; color: #721c24; }
    
    .order-details {
      font-size: 14px;
      color: #666;
    }
    
    .alert {
      padding: 12px 16px;
      border-radius: 8px;
      margin-bottom: 20px;
      font-size: 14px;
    }
    
    .alert-success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    
    .alert-error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    
    .loading {
      text-align: center;
      color: #666;
      font-style: italic;
    }
  </style>
</head>
<body>
  <div class="navbar">
    <div class="navbar-brand">破天充值系统</div>
    <div class="navbar-user">
      {% if user %}
        <div class="user-info">
          <span>欢迎，{{ user.username }}</span>
          <span class="user-role role-{{ user.role }}">{{ '管理员' if user.role == 'admin' else '用户' }}</span>
        </div>
        <a href="{{ url_for('profile') }}" class="btn btn-info">个人资料</a>
        {% if user.role == 'admin' %}
          <a href="{{ url_for('admin') }}" class="btn btn-info">管理后台</a>
          <a href="{{ url_for('sellers') }}" class="btn btn-info">卖家管理</a>
        {% endif %}
        <a href="{{ url_for('orders') }}" class="btn btn-info">订单管理</a>
        <a href="{{ url_for('logout') }}" class="btn btn-danger">退出</a>
      {% else %}
        <a href="{{ url_for('login') }}" class="btn btn-primary">登录</a>
        <a href="{{ url_for('register') }}" class="btn btn-info">注册</a>
      {% endif %}
    </div>
  </div>

  <div class="main-container">
    {% if not user %}
      <!-- 未登录用户显示 -->
      <div class="upload-section">
        <h2>欢迎使用破天充值系统</h2>
        <p style="text-align: center; color: #666; margin: 20px 0;">
          请先登录或注册账户以使用充值服务
        </p>
        <div style="text-align: center;">
          <a href="{{ url_for('login') }}" class="btn btn-primary" style="margin-right: 10px;">立即登录</a>
          <a href="{{ url_for('register') }}" class="btn btn-info">注册账户</a>
        </div>
      </div>
    {% else %}
      <!-- 已登录用户显示上传功能 -->
      <div class="upload-section">
      <h2>上传付款码</h2>
      <form id="uploadForm" enctype="multipart/form-data">
        <div class="form-group">
          <label for="qr_code">付款码图片 * <span style="font-size: 12px; color: #666;">(点击上传框或Ctrl+V粘贴)</span></label>
          <div class="upload-area" id="uploadArea">
            <input type="file" id="qr_code" name="qr_code" accept="image/*" required style="display: none;">
            <div class="upload-placeholder" id="uploadPlaceholder">
              <div class="upload-icon">📷</div>
              <div class="upload-text">点击此处上传图片或粘贴剪切板图片</div>
              <div class="upload-hint">支持 JPG、PNG、GIF 格式</div>
            </div>
            <div class="upload-preview" id="uploadPreview" style="display: none;">
              <img id="previewImage" src="" alt="预览图片">
              <div class="upload-overlay">
                <button type="button" class="change-btn" onclick="changeImage()">更换图片</button>
              </div>
            </div>
          </div>
        </div>
        
        <div class="form-group">
          <label for="package">套餐选择</label>
          <select id="package" name="package">
            <option value="12">12个月</option>
            <option value="6">6个月</option>
            <option value="3">3个月</option>
            <option value="1">1个月</option>
          </select>
        </div>
        
        <div class="form-group">
          <label for="remark">备注信息</label>
          <textarea id="remark" name="remark" rows="3" placeholder="可选：添加备注信息"></textarea>
        </div>
        
        <button type="submit" class="submit-btn">提交订单</button>
      </form>
    </div>

      <!-- 最近订单区域 -->
      <div class="orders-section">
        <h2>最近订单</h2>
        <div id="ordersList">
          <div class="loading">加载中...</div>
        </div>
      </div>
    {% endif %}
  </div>

  <script>
    // 图片上传相关功能
    const uploadArea = document.getElementById('uploadArea');
    const fileInput = document.getElementById('qr_code');
    const uploadPlaceholder = document.getElementById('uploadPlaceholder');
    const uploadPreview = document.getElementById('uploadPreview');
    const previewImage = document.getElementById('previewImage');
    
    // 点击上传区域触发文件选择
    uploadArea.addEventListener('click', function() {
      fileInput.click();
    });
    
    // 文件选择变化
    fileInput.addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (file) {
        handleFileUpload(file);
      }
    });
    
    // 拖拽上传
    uploadArea.addEventListener('dragover', function(e) {
      e.preventDefault();
      uploadArea.classList.add('drag-over');
    });
    
    uploadArea.addEventListener('dragleave', function(e) {
      e.preventDefault();
      uploadArea.classList.remove('drag-over');
    });
    
    uploadArea.addEventListener('drop', function(e) {
      e.preventDefault();
      uploadArea.classList.remove('drag-over');
      
      const files = e.dataTransfer.files;
      if (files.length > 0) {
        const file = files[0];
        if (file.type.startsWith('image/')) {
          handleFileUpload(file);
          fileInput.files = files; // 更新input的files
        } else {
          showAlert('请选择图片文件！', 'error');
        }
      }
    });
    
    // 剪切板粘贴功能
    document.addEventListener('paste', function(e) {
      const items = e.clipboardData.items;
      for (let i = 0; i < items.length; i++) {
        if (items[i].type.indexOf('image') !== -1) {
          const file = items[i].getAsFile();
          handleFileUpload(file);
          
          // 创建一个新的FileList来更新input
          const dt = new DataTransfer();
          dt.items.add(file);
          fileInput.files = dt.files;
          break;
        }
      }
    });
    
    // 处理文件上传预览
    function handleFileUpload(file) {
      if (!file.type.startsWith('image/')) {
        showAlert('请选择图片文件！', 'error');
        return;
      }
      
      // 检查文件大小 (5MB)
      if (file.size > 5 * 1024 * 1024) {
        showAlert('图片文件不能超过5MB！', 'error');
        return;
      }
      
      const reader = new FileReader();
      reader.onload = function(e) {
        previewImage.src = e.target.result;
        uploadPlaceholder.style.display = 'none';
        uploadPreview.style.display = 'block';
      };
      reader.readAsDataURL(file);
    }
    
    // 更换图片
    function changeImage() {
      fileInput.click();
    }
    
    // 重置上传状态
    function resetUpload() {
      uploadPlaceholder.style.display = 'block';
      uploadPreview.style.display = 'none';
      fileInput.value = '';
    }
    
    // 提交订单
    document.getElementById('uploadForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const formData = new FormData(this);
      const submitBtn = this.querySelector('.submit-btn');
      const originalText = submitBtn.textContent;
      
      submitBtn.textContent = '提交中...';
      submitBtn.disabled = true;
      
      try {
        const response = await fetch('/', {
          method: 'POST',
          body: formData
        });
        
        const result = await response.json();
        
        if (result.success) {
          showAlert('订单提交成功！', 'success');
          this.reset();
          resetUpload(); // 重置上传状态
          loadOrders();
        } else {
          showAlert(result.error || '提交失败', 'error');
        }
      } catch (error) {
        showAlert('网络错误，请重试', 'error');
      } finally {
        submitBtn.textContent = originalText;
        submitBtn.disabled = false;
      }
    });

    // 显示提示信息
    function showAlert(message, type) {
      const alert = document.createElement('div');
      alert.className = `alert alert-${type}`;
      alert.textContent = message;
      
      const container = document.querySelector('.main-container');
      container.insertBefore(alert, container.firstChild);
      
      setTimeout(() => {
        alert.remove();
      }, 3000);
    }

    // 加载订单列表
    async function loadOrders() {
      const ordersList = document.getElementById('ordersList');
      if (!ordersList) return; // 如果没有订单列表元素则返回
      
      try {
        const response = await fetch('/orders/recent');
        const result = await response.json();
        
        if (result.success && result.orders) {
          if (result.orders.length === 0) {
            ordersList.innerHTML = '<div class="loading">暂无订单</div>';
            return;
          }
          
          ordersList.innerHTML = result.orders.map(order => `
            <div class="order-item">
              <div class="order-header">
                <span class="order-id">订单 #${order[0]}</span>
                <span class="order-status status-${order[3]}">${getStatusText(order[3])}</span>
              </div>
              <div class="order-details">
                <div>套餐: ${order[2]}个月</div>
                <div>创建时间: ${order[4]}</div>
              </div>
            </div>
          `).join('');
        } else {
          ordersList.innerHTML = '<div class="loading">加载失败</div>';
        }
      } catch (error) {
        ordersList.innerHTML = '<div class="loading">加载失败</div>';
      }
    }

    // 获取状态文本
    function getStatusText(status) {
      const statusMap = {
        'submitted': '已提交',
        'accepted': '已接单',
        'completed': '已完成',
        'failed': '失败',
        'cancelled': '已取消',
        'disputing': '争议中'
      };
      return statusMap[status] || status;
    }

    // 页面加载时获取订单
    window.addEventListener('load', function() {
      // 检查是否有订单列表元素（只有登录用户才有）
      if (document.getElementById('ordersList')) {
        loadOrders();
      }
    });
  </script>
</body>
</html> 